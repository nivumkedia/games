<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Top-Down Racing</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0a1a;display:flex;justify-content:center;align-items:center;min-height:100vh;font-family:'Courier New',monospace;overflow:hidden;color:#fff}
#gameContainer{position:relative;width:800px;height:600px;border-radius:8px;overflow:hidden;box-shadow:0 0 60px rgba(255,68,68,0.15),0 0 120px rgba(0,0,0,0.8)}
canvas{display:block;background:#2d5a1e;border:none}
.screen-overlay{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10}
#menuScreen{background:linear-gradient(135deg,rgba(10,10,30,0.97),rgba(20,5,15,0.97))}
#resultsScreen{background:linear-gradient(135deg,rgba(10,10,30,0.95),rgba(20,5,15,0.95));display:none}
h1{font-size:42px;color:#ff4444;text-shadow:0 0 20px rgba(255,68,68,0.6),0 0 60px rgba(255,68,68,0.3);margin-bottom:8px;letter-spacing:6px}
h2{font-size:20px;color:#aaa;margin-bottom:30px;font-weight:normal;letter-spacing:2px}
.track-select{display:flex;flex-wrap:wrap;gap:16px;margin-bottom:30px;justify-content:center;max-width:700px;max-height:340px;overflow-y:auto;padding:10px}
.track-card{width:120px;padding:8px;background:rgba(255,255,255,0.03);border:2px solid #333;border-radius:10px;cursor:pointer;text-align:center;transition:all 0.3s ease}
.track-card:hover{border-color:#ff4444;background:rgba(255,68,68,0.08);transform:translateY(-4px);box-shadow:0 8px 25px rgba(255,68,68,0.15)}
.track-card.selected{border-color:#ff4444;background:rgba(255,68,68,0.12);box-shadow:0 0 20px rgba(255,68,68,0.25),inset 0 0 20px rgba(255,68,68,0.05)}
.track-card canvas{width:100px;height:70px;border:none;background:#1a3a0e;border-radius:6px;margin-bottom:8px}
.track-card h3{font-size:14px;color:#ff6666;margin-bottom:4px}
.track-card p{font-size:11px;color:#666}
.btn{padding:14px 40px;font-size:18px;font-family:'Courier New',monospace;background:linear-gradient(135deg,#ff4444,#cc2222);color:#fff;border:none;border-radius:8px;cursor:pointer;letter-spacing:3px;transition:all 0.3s ease;text-shadow:0 1px 2px rgba(0,0,0,0.3)}
.btn:hover{background:linear-gradient(135deg,#ff6666,#ee3333);transform:scale(1.05);box-shadow:0 0 30px rgba(255,68,68,0.5)}
.btn-secondary{background:linear-gradient(135deg,#444,#333);font-size:14px;padding:10px 25px}
.btn-secondary:hover{background:linear-gradient(135deg,#666,#555);box-shadow:0 0 20px rgba(255,255,255,0.1)}
.results-table{margin:20px 0;font-size:16px}
.results-table div{padding:8px 20px;display:flex;justify-content:space-between;gap:30px;border-bottom:1px solid #222}
.results-table div:first-child{color:#ffd700;font-size:18px;text-shadow:0 0 10px rgba(255,215,0,0.3)}
.controls-hint{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);font-size:11px;color:#444;letter-spacing:1px}
.mode-select{display:flex;gap:12px;margin-bottom:18px}
.mode-btn{padding:10px 28px;font-size:15px;font-family:'Courier New',monospace;background:linear-gradient(135deg,#333,#222);color:#888;border:2px solid #444;border-radius:8px;cursor:pointer;letter-spacing:2px;transition:all 0.3s ease}
.mode-btn:hover{border-color:#ff4444;color:#fff}
.mode-btn.active{background:linear-gradient(135deg,#ff4444,#cc2222);color:#fff;border-color:#ff6666;box-shadow:0 0 20px rgba(255,68,68,0.3)}
#touchLeft,#touchRight{display:none;position:absolute;bottom:0;width:50%;height:100%;z-index:5;opacity:0}
#touchLeft{left:0}#touchRight{right:0}
</style>
</head>
<body>
<div id="gameContainer">
<canvas id="gameCanvas" width="800" height="600"></canvas>
<div id="touchLeft"></div><div id="touchRight"></div>
<div id="menuScreen" class="screen-overlay">
<h1>TOP-DOWN RACING</h1><h2>Select a Track</h2>
<div class="track-select" id="trackSelect"></div>
<div class="mode-select"><button class="mode-btn active" id="mode1P">1 PLAYER</button><button class="mode-btn" id="mode2P">2 PLAYERS</button></div>
<button class="btn" id="startBtn">START RACE</button>
<div class="controls-hint" id="controlsHint">WASD / Arrows to drive &bull; Space = Nitro &bull; E = Power-up</div>
</div>
<div id="resultsScreen" class="screen-overlay">
<h1 style="font-size:32px;">RACE RESULTS</h1>
<div class="results-table" id="resultsTable"></div>
<div style="display:flex;gap:12px;margin-top:10px;">
<button class="btn btn-secondary" id="menuBtn">MENU</button>
<button class="btn" id="replayBtn">RACE AGAIN</button>
</div></div></div>
<script>
const canvas=document.getElementById('gameCanvas'),ctx=canvas.getContext('2d'),W=800,H=600;
const TRACKS=[
{name:'Oval Sprint',points:(()=>{const p=[],L=9000,R=1500,S=12;for(let i=0;i<=30;i++)p.push({x:-L/2+L*i/30,y:-R});for(let i=0;i<S;i++){const a=-Math.PI/2+Math.PI*i/S;p.push({x:L/2+Math.cos(a)*R,y:Math.sin(a)*R})}for(let i=0;i<=30;i++)p.push({x:L/2-L*i/30,y:R});for(let i=0;i<S;i++){const a=Math.PI/2+Math.PI*i/S;p.push({x:-L/2+Math.cos(a)*R,y:Math.sin(a)*R})}return p})(),roadWidth:300,startAngle:0},
{name:'Figure Eight',points:(()=>{const p=[],N=100,A=4000,B=2000;for(let i=0;i<N;i++){const t=2*Math.PI*i/N;p.push({x:A*Math.cos(t),y:B*Math.sin(2*t)})}return p})(),roadWidth:280,startAngle:0},
{name:'Triangle',points:(()=>{const p=[],sz=3500,N=25;const v=[];for(let i=0;i<3;i++){const a=i*Math.PI*2/3-Math.PI/2;v.push({x:sz*Math.cos(a),y:sz*Math.sin(a)})}for(let e=0;e<3;e++){const a=v[e],b=v[(e+1)%3];for(let i=0;i<N;i++){const t=i/N;p.push({x:a.x+(b.x-a.x)*t,y:a.y+(b.y-a.y)*t})}}return p})(),roadWidth:280,startAngle:0},
{name:'Serpentine',points:(()=>{const p=[],N=100,A=5000,B=1500;for(let i=0;i<N;i++){const t=2*Math.PI*i/N;p.push({x:A*Math.cos(t),y:B*Math.sin(t)+800*Math.sin(3*t)})}return p})(),roadWidth:280,startAngle:0},
{name:'Clover',points:(()=>{const p=[],N=120;for(let i=0;i<N;i++){const t=2*Math.PI*i/N,r=2500+800*Math.cos(3*t);p.push({x:Math.cos(t)*r,y:Math.sin(t)*r})}return p})(),roadWidth:280,startAngle:0},
{name:'Teardrop',points:(()=>{const p=[],N=80;for(let i=0;i<N;i++){const t=2*Math.PI*i/N,r=2500*(1-0.35*Math.cos(t));p.push({x:Math.cos(t)*r,y:Math.sin(t)*r})}return p})(),roadWidth:280,startAngle:0},
{name:'Star Track',points:(()=>{const p=[],N=120;for(let i=0;i<N;i++){const t=2*Math.PI*i/N,r=3000+700*Math.cos(5*t);p.push({x:Math.cos(t)*r,y:Math.sin(t)*r})}return p})(),roadWidth:280,startAngle:0},
{name:'Kidney Bean',points:(()=>{const p=[],N=80;for(let i=0;i<N;i++){const t=2*Math.PI*i/N,r=3000+1500*Math.cos(t);p.push({x:Math.cos(t)*r,y:Math.sin(t)*r})}return p})(),roadWidth:300,startAngle:0},
{name:'Grand Prix',points:(()=>{const p=[],W2=4000,H2=2500,R=1200,S=10;for(let i=0;i<=25;i++)p.push({x:-W2+R+(W2*2-R*2)*i/25,y:-H2});for(let i=0;i<=S;i++){const a=-Math.PI/2+Math.PI/2*i/S;p.push({x:W2-R+R*Math.cos(a),y:-H2+R+R*Math.sin(a)})}for(let i=0;i<=15;i++)p.push({x:W2,y:-H2+R+(H2*2-R*2)*i/15});for(let i=0;i<=S;i++){const a=Math.PI/2*i/S;p.push({x:W2-R+R*Math.cos(a),y:H2-R+R*Math.sin(a)})}for(let i=0;i<=25;i++)p.push({x:W2-R-(W2*2-R*2)*i/25,y:H2});for(let i=0;i<=S;i++){const a=Math.PI/2+Math.PI/2*i/S;p.push({x:-W2+R+R*Math.cos(a),y:H2-R+R*Math.sin(a)})}for(let i=0;i<=15;i++)p.push({x:-W2,y:H2-R-(H2*2-R*2)*i/15});for(let i=0;i<=S;i++){const a=Math.PI+Math.PI/2*i/S;p.push({x:-W2+R+R*Math.cos(a),y:-H2+R+R*Math.sin(a)})}return p})(),roadWidth:280,startAngle:0},
{name:'Speedway',points:(()=>{const p=[],L=11250,R=1875,S=14;for(let i=0;i<=35;i++)p.push({x:-L/2+L*i/35,y:-R});for(let i=0;i<S;i++){const a=-Math.PI/2+Math.PI*i/S;p.push({x:L/2+Math.cos(a)*R,y:Math.sin(a)*R})}for(let i=0;i<=35;i++)p.push({x:L/2-L*i/35,y:R});for(let i=0;i<S;i++){const a=Math.PI/2+Math.PI*i/S;p.push({x:-L/2+Math.cos(a)*R,y:Math.sin(a)*R})}return p})(),roadWidth:300,startAngle:0}
];
let state='menu',selectedTrack=0,track,cars,player,player2,particles,raceTimer,countdownTimer,countdownNum;
let cameraX,cameraY,cameraAngle=0,cameraZoom=1,keys={},raceFinished=false,finishOrder=[];
let multiplayer=false,cam2X=0,cam2Y=0,cam2Angle=0,cam2Zoom=1;
let touchSteerDir=0,touchGas=false,touchBrake=false;
let trackDecorations=[],skidMarks=[];
const CAR_COLORS=['#ff3333','#3399ff','#33cc33','#ffcc00','#ff66cc','#cc66ff'];
const TOTAL_LAPS=3,NITRO_MAX=3,NITRO_RECHARGE_TIME=8000;
var orbs=[],hazards=[],missiles=[],MAX_ORBS=18;
var POWERUP_TYPES=[{name:'Boost',color:'#ff4444',icon:'\u{1F680}'},{name:'Shield',color:'#4488ff',icon:'\u{1F6E1}'},{name:'Banana',color:'#ffcc00',icon:'\u{1F34C}'},{name:'Lightning',color:'#ffff00',icon:'\u26A1'},{name:'Missile',color:'#33cc33',icon:'\u{1F3AF}'},{name:'Star',color:'#ff88ff',icon:'\u2B50'},{name:'Oil',color:'#9933ff',icon:'\u{1F6E2}'},{name:'Mega Boost',color:'#ff8800',icon:'\u{1F525}'},{name:'Ghost',color:'#88ffff',icon:'\u{1F47B}'},{name:'Bomb',color:'#ff0000',icon:'\u{1F4A3}'}];

function generateElevation(pts,hills){hills=hills||3;var n=pts.length;for(var i=0;i<n;i++){var t=i/n*Math.PI*2;pts[i].z=Math.sin(t*hills)*80+Math.sin(t*hills*2.3+1.7)*40+Math.sin(t*hills*0.7+3.1)*30}return pts}
function getSlope(car){var cp=closestPt(car.x,car.y,track);var pts=track.points,n=pts.length,s=cp.seg,t=cp.t;var z0=pts[s].z||0,z1=pts[(s+1)%n].z||0;var curZ=z0+(z1-z0)*t;var ns=(s+1)%n;var z2=pts[(ns+1)%n].z||0;var nextZ=z1+(z2-z1)*t;var segLen=Math.hypot(pts[(s+1)%n].x-pts[s].x,pts[(s+1)%n].y-pts[s].y);return{z:curZ,slope:(nextZ-curZ)/(segLen||1)}}
function smoothTrackPoints(pts){const s=[],n=pts.length;for(let i=0;i<n;i++){const p=pts[(i-1+n)%n],c=pts[i],nx=pts[(i+1)%n];s.push({x:c.x*0.5+p.x*0.25+nx.x*0.25,y:c.y*0.5+p.y*0.25+nx.y*0.25,z:c.z||0})}return s}
function buildCheckpoints(td){const pts=td.points,cp=[],step=Math.max(1,Math.floor(pts.length/12));for(let i=0;i<pts.length;i+=step){const p=pts[i],n=pts[(i+1)%pts.length],a=Math.atan2(n.y-p.y,n.x-p.x);cp.push({x:p.x,y:p.y,nx:Math.cos(a+Math.PI/2),ny:Math.sin(a+Math.PI/2),angle:a})}return cp}
function distToSeg(px,py,ax,ay,bx,by){const dx=bx-ax,dy=by-ay,ls=dx*dx+dy*dy;if(ls===0)return Math.hypot(px-ax,py-ay);let t=((px-ax)*dx+(py-ay)*dy)/ls;t=Math.max(0,Math.min(1,t));return Math.hypot(px-(ax+t*dx),py-(ay+t*dy))}
function isOnRoad(x,y,td){const pts=td.points,hw=td.roadWidth/2;let mn=Infinity;for(let i=0;i<pts.length;i++){const a=pts[i],b=pts[(i+1)%pts.length],d=distToSeg(x,y,a.x,a.y,b.x,b.y);if(d<mn)mn=d}return mn<hw}
function closestPt(x,y,td){const pts=td.points;let mn=Infinity,bx=0,by=0,bs=0,bt=0;for(let i=0;i<pts.length;i++){const a=pts[i],b=pts[(i+1)%pts.length],dx=b.x-a.x,dy=b.y-a.y,ls=dx*dx+dy*dy;let t=ls===0?0:((x-a.x)*dx+(y-a.y)*dy)/ls;t=Math.max(0,Math.min(1,t));const cx=a.x+t*dx,cy=a.y+t*dy,d=Math.hypot(x-cx,y-cy);if(d<mn){mn=d;bx=cx;by=cy;bs=i;bt=t}}return{x:bx,y:by,seg:bs,t:bt,dist:mn}}
function getProgress(car,td){const cp=closestPt(car.x,car.y,td);return cp.seg+cp.t}
function createCar(x,y,angle,color,isPlayer){return{x,y,angle,color,isPlayer,speed:0,width:20,height:32,acceleration:0,steering:0,nitro:NITRO_MAX,nitroTimer:0,nitroActive:false,lap:0,checkpoint:0,lapTimes:[],lapStart:0,totalTime:0,finished:false,finishPos:0,onRoad:true,lastOnRoadX:x,lastOnRoadY:y,lastOnRoadAngle:angle,targetWaypoint:2,aiOffset:(Math.random()-0.5)*30,aiSkill:0.7+Math.random()*0.25,aiBraking:false,powerup:null,shieldActive:false,shieldTimer:0,starActive:false,starTimer:0,slowTimer:0,spinTimer:0,spinAngle:0,ghostActive:false,ghostTimer:0}}
function updateCar(car,dt){
const maxSpd=car.nitroActive?600:500,af=700,bf=500,fr=car.onRoad?120:200,ts=car.onRoad?1.6:0.9;
if(car.acceleration>0)car.speed+=af*dt*car.acceleration;else if(car.acceleration<0)car.speed+=bf*dt*car.acceleration;
if(car.speed>0)car.speed=Math.max(0,car.speed-fr*dt);else if(car.speed<0)car.speed=Math.min(0,car.speed+fr*dt*1.5);
car.speed=Math.max(-100,Math.min(maxSpd,car.speed));
const sf=Math.min(1,Math.abs(car.speed)/100),sa=car.steering*ts*sf*dt;
car.angle+=(car.speed<0?-sa:sa);
car.x+=Math.cos(car.angle-Math.PI/2)*car.speed*dt;car.y+=Math.sin(car.angle-Math.PI/2)*car.speed*dt;
if(track&&track.points[0].z!==undefined){var sl=getSlope(car);car.slope=sl.slope;car.elev=sl.z;car.speed-=sl.slope*car.speed*dt*8}
car.onRoad=isOnRoad(car.x,car.y,track);
if(car.onRoad){car.lastOnRoadX=car.x;car.lastOnRoadY=car.y;car.lastOnRoadAngle=car.angle}else{if(car.speed>100)car.speed+=(100-car.speed)*dt*2;if(car.speed<-30)car.speed+=(-30-car.speed)*dt*2;var cp=closestPt(car.x,car.y,track);if(!car.isPlayer&&cp.dist>track.roadWidth*0.6){var pullX=cp.x-car.x,pullY=cp.y-car.y,pullD=Math.hypot(pullX,pullY);if(pullD>0){car.x+=pullX/pullD*dt*400;car.y+=pullY/pullD*dt*400}}if(cp.dist>track.roadWidth*2){car.x=car.lastOnRoadX;car.y=car.lastOnRoadY;car.angle=car.lastOnRoadAngle;car.speed=50}}
if(!car.nitroActive&&car.nitro<NITRO_MAX){car.nitroTimer+=dt*1000;if(car.nitroTimer>=NITRO_RECHARGE_TIME){car.nitro=Math.min(NITRO_MAX,car.nitro+1);car.nitroTimer=0}}
if(car.nitroActive){car.nitroDuration-=dt;if(car.nitroDuration<=0)car.nitroActive=false}}
function activateNitro(car){if(car.nitro>0&&!car.nitroActive){car.nitro--;car.nitroActive=true;car.nitroDuration=1.2;car.nitroTimer=0;car.speed=Math.min(car.speed+80,380)}}
function carCollisions(){for(let i=0;i<cars.length;i++)for(let j=i+1;j<cars.length;j++){const a=cars[i],b=cars[j],dx=b.x-a.x,dy=b.y-a.y,d=Math.hypot(dx,dy);if(d<28&&d>0){const nx=dx/d,ny=dy/d,ol=28-d;a.x-=nx*ol*0.5;a.y-=ny*ol*0.5;b.x+=nx*ol*0.5;b.y+=ny*ol*0.5;const rs=(a.speed-b.speed)*0.3;a.speed-=rs;b.speed+=rs;for(let s=0;s<5;s++){const sp=createParticle((a.x+b.x)/2,(a.y+b.y)/2,'spark');sp.vx=(Math.random()-0.5)*200;sp.vy=(Math.random()-0.5)*200;sp.life=0.15+Math.random()*0.2;sp.maxLife=sp.life;sp.size=1+Math.random()*2;particles.push(sp)}}}}
function updateCheckpoints(car){if(car.finished)return;const cps=track.checkpoints,nc=cps[car.checkpoint%cps.length],dx=car.x-nc.x,dy=car.y-nc.y,dist=Math.hypot(dx,dy);if(dist<track.roadWidth*0.8){car.checkpoint++;if(car.checkpoint%cps.length===0&&car.checkpoint>0){car.lap++;const now=performance.now();car.lapTimes.push(now-car.lapStart);car.lapStart=now;if(car.lap>=TOTAL_LAPS){car.finished=true;car.totalTime=car.lapTimes.reduce((a,b)=>a+b,0);finishOrder.push(car);car.finishPos=finishOrder.length}}}}
function calcPositions(){const s=[...cars].sort((a,b)=>{if(a.finished&&b.finished)return a.finishPos-b.finishPos;if(a.finished)return-1;if(b.finished)return 1;if(a.lap!==b.lap)return b.lap-a.lap;if(a.checkpoint!==b.checkpoint)return b.checkpoint-a.checkpoint;return getProgress(b,track)-getProgress(a,track)});s.forEach((c,i)=>c.position=i+1)}
function updateAI(car,dt){if(car.spinTimer>0)return;const pts=track.points,n=pts.length;
// Look further ahead for smoother racing lines
var lookDist=Math.max(3,Math.floor(Math.abs(car.speed)/40));
var tgt=pts[(car.targetWaypoint+lookDist)%n];
var dx=tgt.x+car.aiOffset-car.x,dy=tgt.y+car.aiOffset-car.y,d=Math.hypot(dx,dy);
var ta=Math.atan2(dy,dx)+Math.PI/2;
// Advance waypoint
if(d<500){car.targetWaypoint=(car.targetWaypoint+1)%n;car.aiOffset=(Math.random()-0.5)*20}
// Smooth steering
var ad=ta-car.angle;while(ad>Math.PI)ad-=Math.PI*2;while(ad<-Math.PI)ad+=Math.PI*2;
car.steering=Math.max(-1,Math.min(1,ad*2.5));
// Look ahead multiple waypoints for upcoming turns
var sharpest=0;for(var la=1;la<=8;la++){var p1=pts[(car.targetWaypoint+la)%n],p2=pts[(car.targetWaypoint+la+1)%n],p0=pts[(car.targetWaypoint+la-1)%n];var ax2=p1.x-p0.x,ay2=p1.y-p0.y,bx2=p2.x-p1.x,by2=p2.y-p1.y;var cross=Math.abs(ax2*by2-ay2*bx2)/(Math.hypot(ax2,ay2)*Math.hypot(bx2,by2)+1);if(cross>sharpest)sharpest=cross}
// Speed control based on upcoming turns
var sm=car.aiSkill;
if(player&&!player.finished){var pp=player.lap*1000+player.checkpoint*10+getProgress(player,track),ap=car.lap*1000+car.checkpoint*10+getProgress(car,track);if(ap>pp+5)sm*=0.8;else if(ap<pp-5)sm*=1.15}
if(sharpest>0.4&&car.speed>200)car.acceleration=-0.6;
else if(sharpest>0.2&&car.speed>300)car.acceleration=-0.3;
else car.acceleration=sm;
// Use nitro on straights
if(car.nitro>0&&car.speed>150&&sharpest<0.08&&Math.random()<0.01)activateNitro(car);
// Avoid other cars
for(var oi=0;oi<cars.length;oi++){var oc=cars[oi];if(oc===car)continue;var odx=oc.x-car.x,ody=oc.y-car.y,od=Math.hypot(odx,ody);if(od<60&&od>0){var oang=Math.atan2(ody,odx)-car.angle+Math.PI/2;while(oang>Math.PI)oang-=Math.PI*2;while(oang<-Math.PI)oang+=Math.PI*2;if(Math.abs(oang)<Math.PI/3)car.steering+=oang>0?-0.3:0.3}}}
function createParticle(x,y,type){return{x,y,type,vx:(Math.random()-0.5)*60,vy:(Math.random()-0.5)*60,life:0.3+Math.random()*0.3,maxLife:0.3+Math.random()*0.3,size:2+Math.random()*3}}
function updateParticles(dt){for(let i=particles.length-1;i>=0;i--){const p=particles[i];p.x+=p.vx*dt;p.y+=p.vy*dt;p.life-=dt;if(p.life<=0)particles.splice(i,1)}for(let i=skidMarks.length-1;i>=0;i--){skidMarks[i].life-=dt*0.05;if(skidMarks[i].life<=0)skidMarks.splice(i,1)}if(skidMarks.length>500)skidMarks.splice(0,skidMarks.length-500)}
function spawnCarParticles(car){if(Math.abs(car.steering)>0.5&&Math.abs(car.speed)>100){const p=createParticle(car.x,car.y,'smoke');p.vx*=0.5;p.vy*=0.5;particles.push(p);if(car.onRoad){const c=Math.cos(car.angle),s=Math.sin(car.angle);skidMarks.push({x:car.x-c*6+s*8,y:car.y-s*6-c*8,life:1},{x:car.x-c*6-s*8,y:car.y-s*6+c*8,life:1})}}if(car.nitroActive){const bx=car.x-Math.cos(car.angle-Math.PI/2)*18,by=car.y-Math.sin(car.angle-Math.PI/2)*18;for(let i=0;i<3;i++){const p=createParticle(bx,by,'nitro');p.vx=-Math.cos(car.angle-Math.PI/2)*(120+Math.random()*80);p.vy=-Math.sin(car.angle-Math.PI/2)*(120+Math.random()*80);p.size=3+Math.random()*5;p.life=0.2+Math.random()*0.3;p.maxLife=p.life;particles.push(p)}}if(!car.onRoad&&Math.abs(car.speed)>30){const p=createParticle(car.x,car.y,'dust');p.size=3+Math.random()*4;particles.push(p)}}
function shadeColor(c,a){if(!c.startsWith('#'))return c;const n=parseInt(c.slice(1),16);return'rgb('+Math.min(255,Math.max(0,((n>>16)&0xFF)+a))+','+Math.min(255,Math.max(0,((n>>8)&0xFF)+a))+','+Math.min(255,Math.max(0,(n&0xFF)+a))+')'}
function generateDecorations(td){trackDecorations=[];const pts=td.points,hw=td.roadWidth/2,sd=function(i){return((i*9301+49297)%233280)/233280};for(let i=0;i<pts.length;i++){const p=pts[i],n=pts[(i+1)%pts.length],a=Math.atan2(n.y-p.y,n.x-p.x),px=Math.cos(a+Math.PI/2),py=Math.sin(a+Math.PI/2);for(var si=-1;si<=1;si+=2){const r1=sd(i*7+si*31),r2=sd(i*13+si*47),r3=sd(i*19+si*61);if(r1<0.55)trackDecorations.push({type:'tree',x:p.x+px*(hw+50+r2*100)*si,y:p.y+py*(hw+50+r2*100)*si,size:14+r3*16,shade:r2});if(r1>0.7&&r1<0.85)trackDecorations.push({type:'bush',x:p.x+px*(hw+25+r3*40)*si,y:p.y+py*(hw+25+r3*40)*si,size:6+r2*8,shade:r3})}if(i%8===0)for(var si2=-1;si2<=1;si2+=2)if(sd(i*23+si2)<0.3)trackDecorations.push({type:'barrier',x:p.x+px*(hw+8)*si2,y:p.y+py*(hw+8)*si2,size:6,shade:0})}}
function drawTree(x,y,sz,sh){ctx.fillStyle='rgba(0,0,0,0.25)';ctx.beginPath();ctx.ellipse(x+5,y+5,sz*0.9,sz*0.65,0.3,0,Math.PI*2);ctx.fill();ctx.fillStyle='#4a2a0a';ctx.beginPath();ctx.ellipse(x,y+2,3,5,0,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgb('+(20+(sh*15|0))+','+(60+(sh*40|0))+','+(15+(sh*10|0))+')';ctx.beginPath();ctx.arc(x+1,y+2,sz,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgb('+(30+(sh*20|0))+','+(80+(sh*50|0))+','+(20+(sh*15|0))+')';ctx.beginPath();ctx.arc(x,y,sz*0.85,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgb('+(50+(sh*25|0))+','+(100+(sh*40|0))+','+(35+(sh*20|0))+')';ctx.beginPath();ctx.arc(x-sz*0.25,y-sz*0.25,sz*0.45,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(180,220,140,0.15)';ctx.beginPath();ctx.arc(x-sz*0.3,y-sz*0.35,sz*0.2,0,Math.PI*2);ctx.fill()}
function drawBush(x,y,sz,sh){ctx.fillStyle='rgba(0,0,0,0.15)';ctx.beginPath();ctx.ellipse(x+2,y+3,sz,sz*0.6,0,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgb('+(25+(sh*15|0))+','+(70+(sh*50|0))+','+(18+(sh*12|0))+')';ctx.beginPath();ctx.arc(x,y,sz,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(100,180,60,0.2)';ctx.beginPath();ctx.arc(x-sz*0.2,y-sz*0.2,sz*0.5,0,Math.PI*2);ctx.fill()}
function drawBarrier(x,y){ctx.fillStyle='#222';ctx.beginPath();ctx.arc(x,y,6,0,Math.PI*2);ctx.fill();ctx.fillStyle='#333';ctx.beginPath();ctx.arc(x,y,4,0,Math.PI*2);ctx.fill();ctx.strokeStyle='#ff4444';ctx.lineWidth=1;ctx.beginPath();ctx.arc(x,y,5,0,Math.PI*2);ctx.stroke()}
function drawDirectionArrow(){if(!player||player.finished)return;ctx.save();ctx.setTransform(1,0,0,1,0,0);var cps=track.checkpoints,cp=cps[player.checkpoint%cps.length];var dx=cp.x-player.x,dy=cp.y-player.y,a=Math.atan2(dy,dx)+cameraAngle;var ax=W/2+Math.cos(a)*80,ay=H/2+Math.sin(a)*80,sz=30;ctx.save();ctx.translate(ax,ay);ctx.rotate(a);ctx.shadowColor='rgba(255,136,0,0.8)';ctx.shadowBlur=15;ctx.fillStyle='#ff8800';ctx.beginPath();ctx.moveTo(sz,0);ctx.lineTo(-sz*0.7,-sz*0.65);ctx.lineTo(-sz*0.25,0);ctx.lineTo(-sz*0.7,sz*0.65);ctx.closePath();ctx.fill();ctx.shadowBlur=0;ctx.fillStyle='rgba(255,220,100,0.6)';ctx.beginPath();ctx.moveTo(sz*0.6,0);ctx.lineTo(-sz*0.3,-sz*0.3);ctx.lineTo(-sz*0.1,0);ctx.lineTo(-sz*0.3,sz*0.3);ctx.closePath();ctx.fill();ctx.restore();ctx.restore()}
function drawTrackLine(style,width){const pts=track.points;ctx.save();ctx.strokeStyle=style;ctx.lineWidth=width;ctx.lineCap='round';ctx.lineJoin='round';ctx.beginPath();ctx.moveTo(pts[0].x,pts[0].y);for(let i=1;i<=pts.length;i++)ctx.lineTo(pts[i%pts.length].x,pts[i%pts.length].y);ctx.closePath();ctx.stroke();ctx.restore()}
function drawTrack(){var pts=track.points,hw=track.roadWidth/2;drawTrackLine('#8a7a4a',track.roadWidth+35);drawTrackLine('#7a6a3a',track.roadWidth+20);drawTrackLine('#1a1a1a',track.roadWidth+10);ctx.save();ctx.strokeStyle='#cc0000';ctx.lineWidth=track.roadWidth+6;ctx.lineCap='round';ctx.lineJoin='round';ctx.setLineDash([12,12]);ctx.beginPath();ctx.moveTo(pts[0].x,pts[0].y);for(let i=1;i<=pts.length;i++)ctx.lineTo(pts[i%pts.length].x,pts[i%pts.length].y);ctx.closePath();ctx.stroke();ctx.strokeStyle='#fff';ctx.lineDashOffset=12;ctx.stroke();ctx.restore();drawTrackLine('#3a3a3a',track.roadWidth);if(pts[0].z!==undefined){ctx.save();ctx.lineWidth=track.roadWidth*0.9;ctx.lineCap='round';ctx.lineJoin='round';for(let i=0;i<pts.length;i++){var p=pts[i],np=pts[(i+1)%pts.length],z=(p.z+np.z)/2,zn=Math.max(-1,Math.min(1,z/100));if(zn>0){ctx.strokeStyle='rgba(255,255,200,'+(zn*0.12)+')'}else{ctx.strokeStyle='rgba(0,0,30,'+((-zn)*0.15)+')'}ctx.beginPath();ctx.moveTo(p.x,p.y);ctx.lineTo(np.x,np.y);ctx.stroke()}ctx.lineWidth=3;for(let i=0;i<pts.length;i+=Math.max(1,Math.floor(pts.length/40))){var p=pts[i],np=pts[(i+1)%pts.length],dz=(np.z||0)-(p.z||0);if(Math.abs(dz)>3){var mx=(p.x+np.x)/2,my=(p.y+np.y)/2,ang=Math.atan2(np.y-p.y,np.x-p.x);ctx.save();ctx.translate(mx,my);ctx.rotate(ang);if(dz>0){ctx.fillStyle='rgba(255,100,100,0.25)';ctx.beginPath();ctx.moveTo(0,-12);ctx.lineTo(8,6);ctx.lineTo(-8,6);ctx.closePath();ctx.fill()}else{ctx.fillStyle='rgba(100,200,255,0.25)';ctx.beginPath();ctx.moveTo(0,12);ctx.lineTo(8,-6);ctx.lineTo(-8,-6);ctx.closePath();ctx.fill()}ctx.restore()}}ctx.restore()}drawTrackLine('rgba(80,80,80,0.25)',track.roadWidth*0.6);for(var m of skidMarks){ctx.fillStyle='rgba(20,20,20,'+(m.life*0.35)+')';ctx.beginPath();ctx.arc(m.x,m.y,2,0,Math.PI*2);ctx.fill()}ctx.save();ctx.strokeStyle='rgba(255,255,255,0.12)';ctx.lineWidth=1.5;for(var off of[-0.42,0.42]){ctx.beginPath();for(let i=0;i<=pts.length;i++){var p=pts[i%pts.length],n=pts[(i+1)%pts.length],a=Math.atan2(n.y-p.y,n.x-p.x);var ox=p.x+Math.cos(a+Math.PI/2)*track.roadWidth*off,oy=p.y+Math.sin(a+Math.PI/2)*track.roadWidth*off;i===0?ctx.moveTo(ox,oy):ctx.lineTo(ox,oy)}ctx.stroke()}ctx.restore();ctx.save();ctx.strokeStyle='rgba(200,200,200,0.35)';ctx.lineWidth=2;ctx.setLineDash([15,20]);ctx.beginPath();ctx.moveTo(pts[0].x,pts[0].y);for(let i=1;i<=pts.length;i++)ctx.lineTo(pts[i%pts.length].x,pts[i%pts.length].y);ctx.closePath();ctx.stroke();ctx.restore();var sp=pts[0],sn=pts[1],sa=Math.atan2(sn.y-sp.y,sn.x-sp.x),px=Math.cos(sa+Math.PI/2),py=Math.sin(sa+Math.PI/2),cs=8,nc=Math.floor(track.roadWidth/cs);for(let r=0;r<3;r++)for(let c=0;c<nc;c++){ctx.fillStyle=(r+c)%2===0?'#fff':'#111';ctx.save();ctx.translate(sp.x+px*(c*cs-hw)+Math.cos(sa)*(r*cs-cs*1.5),sp.y+py*(c*cs-hw)+Math.sin(sa)*(r*cs-cs*1.5));ctx.rotate(sa);ctx.fillRect(-cs/2,-cs/2,cs,cs);ctx.restore()}}
function drawCar(car){var w=car.width,h=car.height;ctx.save();ctx.translate(car.x,car.y);ctx.rotate(car.angle);ctx.fillStyle='rgba(0,0,0,0.35)';ctx.beginPath();ctx.ellipse(4,4,w/2+2,h/2+1,0,0,Math.PI*2);ctx.fill();var wp=[[-w/2-2,-h/2+4],[w/2-3,-h/2+4],[-w/2-2,h/2-12],[w/2-3,h/2-12]];for(var wh of wp){ctx.fillStyle='rgba(0,0,0,0.3)';ctx.fillRect(wh[0]+1,wh[1]+1,5,9);ctx.fillStyle='#1a1a1a';ctx.fillRect(wh[0],wh[1],5,9);ctx.fillStyle='#555';ctx.fillRect(wh[0]+1,wh[1]+1,3,7);ctx.fillStyle='#777';ctx.fillRect(wh[0]+1,wh[1]+2,3,2)}var bg=ctx.createLinearGradient(-w/2,0,w/2,0);bg.addColorStop(0,shadeColor(car.color,-50));bg.addColorStop(0.2,shadeColor(car.color,-10));bg.addColorStop(0.45,shadeColor(car.color,40));bg.addColorStop(0.55,shadeColor(car.color,40));bg.addColorStop(0.8,shadeColor(car.color,-10));bg.addColorStop(1,shadeColor(car.color,-50));ctx.fillStyle=bg;var br=4;ctx.beginPath();ctx.moveTo(-w/2+br,-h/2);ctx.lineTo(w/2-br,-h/2);ctx.quadraticCurveTo(w/2,-h/2,w/2,-h/2+br);ctx.lineTo(w/2,h/2-br);ctx.quadraticCurveTo(w/2,h/2,w/2-br,h/2);ctx.lineTo(-w/2+br,h/2);ctx.quadraticCurveTo(-w/2,h/2,-w/2,h/2-br);ctx.lineTo(-w/2,-h/2+br);ctx.quadraticCurveTo(-w/2,-h/2,-w/2+br,-h/2);ctx.closePath();ctx.fill();ctx.strokeStyle=shadeColor(car.color,-70);ctx.lineWidth=1;ctx.stroke();ctx.strokeStyle='rgba(255,255,255,0.08)';ctx.beginPath();ctx.moveTo(-w/2+3,-h/2+13);ctx.lineTo(w/2-3,-h/2+13);ctx.stroke();var wg=ctx.createLinearGradient(-w/2+3,-h/2+2,w/2-3,-h/2+12);wg.addColorStop(0,'rgba(60,140,200,0.85)');wg.addColorStop(0.4,'rgba(130,200,240,0.95)');wg.addColorStop(0.6,'rgba(180,230,255,0.95)');wg.addColorStop(1,'rgba(60,140,200,0.8)');ctx.fillStyle=wg;ctx.beginPath();ctx.moveTo(-w/2+4,-h/2+3);ctx.lineTo(w/2-4,-h/2+3);ctx.lineTo(w/2-3,-h/2+12);ctx.lineTo(-w/2+3,-h/2+12);ctx.closePath();ctx.fill();ctx.fillStyle='rgba(255,255,255,0.25)';ctx.beginPath();ctx.moveTo(-2,-h/2+3);ctx.lineTo(4,-h/2+3);ctx.lineTo(2,-h/2+11);ctx.lineTo(-4,-h/2+11);ctx.closePath();ctx.fill();ctx.fillStyle='rgba(50,100,160,0.5)';ctx.fillRect(-w/2+4,h/2-9,w-8,5);ctx.save();ctx.shadowColor='rgba(255,255,200,0.6)';ctx.shadowBlur=8;ctx.fillStyle='#ffffcc';ctx.beginPath();ctx.ellipse(-w/2+3,-h/2+1,2.5,1.5,0,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.ellipse(w/2-3,-h/2+1,2.5,1.5,0,0,Math.PI*2);ctx.fill();ctx.restore();ctx.save();ctx.shadowColor='rgba(255,0,0,0.6)';ctx.shadowBlur=6;ctx.fillStyle='#ff2222';ctx.fillRect(-w/2+1,h/2-3,4,2);ctx.fillRect(w/2-5,h/2-3,4,2);ctx.restore();ctx.fillStyle='rgba(255,255,255,0.1)';ctx.fillRect(-1.5,-h/2,3,h);var hg=ctx.createLinearGradient(0,-h/2,0,-h/2+h*0.3);hg.addColorStop(0,'rgba(255,255,255,0.15)');hg.addColorStop(1,'rgba(255,255,255,0)');ctx.fillStyle=hg;ctx.fillRect(-w/2+1,-h/2+13,w-2,h*0.3);ctx.fillStyle=shadeColor(car.color,-60);ctx.fillRect(-w/2+1,h/2-1.5,w-2,1.5);ctx.restore();if(car.nitroActive){ctx.save();ctx.translate(car.x,car.y);ctx.rotate(car.angle);var ng=ctx.createRadialGradient(0,h/2+8,0,0,h/2+8,30);ng.addColorStop(0,'rgba(255,200,50,0.5)');ng.addColorStop(0.4,'rgba(255,100,0,0.25)');ng.addColorStop(1,'rgba(255,50,0,0)');ctx.fillStyle=ng;ctx.beginPath();ctx.arc(0,h/2+8,30,0,Math.PI*2);ctx.fill();ctx.restore()}if(car.isPlayer){ctx.save();ctx.translate(car.x,car.y);ctx.rotate(car.angle);var pu=Math.sin(performance.now()*0.006)*0.5+0.5,ay=-h/2-12-pu*3;ctx.fillStyle='rgba(255,255,255,'+(0.15+pu*0.1)+')';ctx.beginPath();ctx.moveTo(0,ay-3);ctx.lineTo(-7,ay+5);ctx.lineTo(7,ay+5);ctx.closePath();ctx.fill();ctx.fillStyle='rgba(255,255,255,'+(0.6+pu*0.4)+')';ctx.beginPath();ctx.moveTo(0,ay);ctx.lineTo(-5,ay+6);ctx.lineTo(5,ay+6);ctx.closePath();ctx.fill();ctx.restore()}}
function drawParticles(){for(var p of particles){var a=p.life/p.maxLife;if(p.type==='smoke'){ctx.fillStyle='rgba(180,180,180,'+(a*0.4)+')';ctx.beginPath();ctx.arc(p.x,p.y,p.size*(1.5-a*0.5),0,Math.PI*2);ctx.fill()}else if(p.type==='nitro'){ctx.fillStyle='rgba(255,255,200,'+(a*0.9)+')';ctx.beginPath();ctx.arc(p.x,p.y,p.size*a*0.4,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(255,'+(120+100*a|0)+',0,'+(a*0.7)+')';ctx.beginPath();ctx.arc(p.x,p.y,p.size*a*0.7,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(255,'+(60+60*a|0)+',0,'+(a*0.3)+')';ctx.beginPath();ctx.arc(p.x,p.y,p.size*a,0,Math.PI*2);ctx.fill()}else if(p.type==='dust'){ctx.fillStyle='rgba(160,140,90,'+(a*0.5)+')';ctx.beginPath();ctx.arc(p.x,p.y,p.size*(1.3-a*0.3),0,Math.PI*2);ctx.fill()}else if(p.type==='spark'){ctx.fillStyle='rgba(255,'+(200+55*a|0)+','+(50+150*a|0)+','+a+')';ctx.beginPath();ctx.arc(p.x,p.y,p.size*a,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(255,255,255,'+(a*0.8)+')';ctx.beginPath();ctx.arc(p.x,p.y,p.size*a*0.4,0,Math.PI*2);ctx.fill()}}}
function drawDecorations(){var vm=500;for(var d of trackDecorations){if(Math.abs(d.x-cameraX)>W/2+vm||Math.abs(d.y-cameraY)>H/2+vm)continue;if(d.type==='tree')drawTree(d.x,d.y,d.size,d.shade);else if(d.type==='bush')drawBush(d.x,d.y,d.size,d.shade);else if(d.type==='barrier')drawBarrier(d.x,d.y)}}
function drawSpeedLines(){if(!player)return;var spd=Math.abs(player.speed);if(spd<220)return;var int=Math.min(1,(spd-220)/130),n=int*12|0;ctx.save();ctx.setTransform(1,0,0,1,0,0);var ang=player.angle-Math.PI/2;for(let i=0;i<n;i++){var x=Math.random()*W,y=Math.random()*H,l=15+Math.random()*35*int;ctx.strokeStyle='rgba(255,255,255,'+(0.06+Math.random()*0.12*int)+')';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x-Math.cos(ang)*l,y-Math.sin(ang)*l);ctx.stroke()}ctx.restore()}
function drawVignette(){ctx.save();ctx.setTransform(1,0,0,1,0,0);var g=ctx.createRadialGradient(W/2,H/2,W*0.3,W/2,H/2,W*0.75);g.addColorStop(0,'rgba(0,0,0,0)');g.addColorStop(1,'rgba(0,0,0,0.35)');ctx.fillStyle=g;ctx.fillRect(0,0,W,H);ctx.restore()}
function drawPanel(x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath()}
function drawHUD(){ctx.save();ctx.setTransform(1,0,0,1,0,0);ctx.fillStyle='rgba(0,0,0,0.65)';drawPanel(10,10,90,48,6);ctx.fill();ctx.strokeStyle='rgba(255,215,0,0.3)';ctx.lineWidth=1;ctx.stroke();ctx.fillStyle='#ffd700';ctx.font='bold 30px Courier New';ctx.fillText(player.position+'',22,45);ctx.fillStyle='#cca800';ctx.font='14px Courier New';ctx.fillText(getOrdinal(player.position),52,45);ctx.fillStyle='rgba(0,0,0,0.65)';drawPanel(110,10,110,48,6);ctx.fill();ctx.strokeStyle='rgba(255,255,255,0.1)';ctx.lineWidth=1;ctx.stroke();ctx.fillStyle='#888';ctx.font='11px Courier New';ctx.fillText('LAP',122,27);ctx.fillStyle='#fff';ctx.font='bold 22px Courier New';ctx.fillText(Math.min(player.lap+1,TOTAL_LAPS)+'/'+TOTAL_LAPS,122,50);ctx.fillStyle='rgba(0,0,0,0.65)';drawPanel(230,10,120,48,6);ctx.fill();ctx.strokeStyle='rgba(0,255,0,0.15)';ctx.lineWidth=1;ctx.stroke();ctx.fillStyle='#666';ctx.font='11px Courier New';ctx.fillText('SPEED',242,27);var ds=Math.abs(Math.round(player.speed*0.6));ctx.fillStyle=ds>180?'#ff4444':ds>120?'#ffaa00':'#00dd00';ctx.font='bold 20px Courier New';ctx.fillText(ds+'',242,50);ctx.fillStyle='#666';ctx.font='12px Courier New';ctx.fillText('km/h',295,50);ctx.fillStyle='rgba(0,0,0,0.65)';drawPanel(360,10,130,48,6);ctx.fill();ctx.strokeStyle='rgba(255,255,255,0.1)';ctx.lineWidth=1;ctx.stroke();ctx.fillStyle='#666';ctx.font='11px Courier New';ctx.fillText('TIME',372,27);ctx.fillStyle='#fff';ctx.font='bold 20px Courier New';ctx.fillText(formatTime(performance.now()-raceTimer),372,50);ctx.fillStyle='rgba(0,0,0,0.65)';drawPanel(10,68,130,28,5);ctx.fill();ctx.strokeStyle='rgba(255,136,0,0.2)';ctx.lineWidth=1;ctx.stroke();ctx.fillStyle='#888';ctx.font='10px Courier New';ctx.fillText('NITRO',18,82);for(let i=0;i<NITRO_MAX;i++){var nx=68+i*22,ny=73;if(i<player.nitro){ctx.save();ctx.shadowColor='rgba(255,136,0,0.5)';ctx.shadowBlur=6;var ng2=ctx.createLinearGradient(nx,ny,nx,ny+16);ng2.addColorStop(0,'#ffaa00');ng2.addColorStop(1,'#ff6600');ctx.fillStyle=ng2;ctx.fillRect(nx,ny,17,16);ctx.restore();ctx.fillStyle='rgba(255,255,255,0.6)';ctx.font='10px sans-serif';ctx.fillText('\u26A1',nx+3,ny+13)}else{ctx.fillStyle='#222';ctx.fillRect(nx,ny,17,16);ctx.strokeStyle='#333';ctx.lineWidth=1;ctx.strokeRect(nx,ny,17,16)}}drawMinimap();if(player.slope!==undefined){var sl=player.slope||0,slAbs=Math.min(1,Math.abs(sl)*15);if(slAbs>0.05){ctx.fillStyle='rgba(0,0,0,0.65)';drawPanel(500,10,90,48,6);ctx.fill();ctx.strokeStyle=sl>0?'rgba(255,100,100,0.3)':'rgba(100,200,255,0.3)';ctx.lineWidth=1;ctx.stroke();ctx.fillStyle=sl>0?'#ff6666':'#66ccff';ctx.font='bold 18px Courier New';ctx.fillText(sl>0?'UPHILL':'DOWNHILL',510,40);ctx.fillStyle=sl>0?'#ff6666':'#66ccff';var ay2=sl>0?20:38;ctx.beginPath();if(sl>0){ctx.moveTo(560,20);ctx.lineTo(553,32);ctx.lineTo(567,32)}else{ctx.moveTo(560,38);ctx.lineTo(553,26);ctx.lineTo(567,26)}ctx.closePath();ctx.fill()}}ctx.restore()}
function drawMinimap(){var mW=150,mH=115,mX=W-mW-10,mY=10;ctx.fillStyle='rgba(0,0,0,0.7)';drawPanel(mX,mY,mW,mH,6);ctx.fill();ctx.strokeStyle='rgba(255,255,255,0.1)';ctx.lineWidth=1;ctx.stroke();var pts=track.points,mnX=Infinity,mxX=-Infinity,mnY=Infinity,mxY=-Infinity;for(var p of pts){mnX=Math.min(mnX,p.x);mxX=Math.max(mxX,p.x);mnY=Math.min(mnY,p.y);mxY=Math.max(mxY,p.y)}var pd=40,sc=Math.min((mW-20)/(mxX-mnX+pd*2),(mH-20)/(mxY-mnY+pd*2)),oX=mX+mW/2-((mxX+mnX)/2)*sc,oY=mY+mH/2-((mxY+mnY)/2)*sc;ctx.strokeStyle='#555';ctx.lineWidth=4;ctx.lineCap='round';ctx.lineJoin='round';ctx.beginPath();ctx.moveTo(pts[0].x*sc+oX,pts[0].y*sc+oY);for(let i=1;i<=pts.length;i++)ctx.lineTo(pts[i%pts.length].x*sc+oX,pts[i%pts.length].y*sc+oY);ctx.closePath();ctx.stroke();ctx.strokeStyle='#777';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(pts[0].x*sc+oX,pts[0].y*sc+oY);for(let i=1;i<=pts.length;i++)ctx.lineTo(pts[i%pts.length].x*sc+oX,pts[i%pts.length].y*sc+oY);ctx.closePath();ctx.stroke();for(var car of cars){var cx=car.x*sc+oX,cy=car.y*sc+oY;if(car.isPlayer){ctx.fillStyle='rgba(255,255,255,0.2)';ctx.beginPath();ctx.arc(cx,cy,6,0,Math.PI*2);ctx.fill()}ctx.fillStyle=car.color;ctx.beginPath();ctx.arc(cx,cy,car.isPlayer?4:3,0,Math.PI*2);ctx.fill();if(car.isPlayer){ctx.strokeStyle='#fff';ctx.lineWidth=1.5;ctx.stroke()}}}
function drawCountdown(){ctx.save();ctx.setTransform(1,0,0,1,0,0);ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(0,0,W,H);var t=countdownNum>0?countdownNum.toString():'GO!',ig=countdownNum<=0;var gg=ctx.createRadialGradient(W/2,H/2,0,W/2,H/2,120);gg.addColorStop(0,ig?'rgba(0,255,0,0.15)':'rgba(255,255,255,0.1)');gg.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=gg;ctx.fillRect(0,0,W,H);ctx.font='bold '+(ig?80:120)+'px Courier New';ctx.textAlign='center';ctx.textBaseline='middle';var sc2=1+Math.sin(performance.now()*0.01)*0.05;ctx.save();ctx.translate(W/2,H/2);ctx.scale(sc2,sc2);ctx.fillStyle=ig?'rgba(0,255,68,0.3)':'rgba(255,255,255,0.2)';ctx.fillText(t,2,2);ctx.fillStyle=ig?'#00ff44':'#fff';ctx.fillText(t,0,0);ctx.restore();ctx.textAlign='start';ctx.textBaseline='alphabetic';ctx.restore()}
function getOrdinal(n){var s=['th','st','nd','rd'],v=n%100;return s[(v-20)%10]||s[v]||s[0]}
function formatTime(ms){var t=ms/1000;return Math.floor(t/60)+':'+Math.floor(t%60).toString().padStart(2,'0')+'.'+Math.floor((t%1)*10)}
function spawnOrbs(){orbs=[];hazards=[];missiles=[];var pts=track.points,n=pts.length;for(var i=0;i<MAX_ORBS;i++){var si=Math.floor(Math.random()*n),p=pts[si],np=pts[(si+1)%n],t=Math.random();var a=Math.atan2(np.y-p.y,np.x-p.x),off=(Math.random()-0.5)*track.roadWidth*0.4;orbs.push({x:p.x+(np.x-p.x)*t+Math.cos(a+Math.PI/2)*off,y:p.y+(np.y-p.y)*t+Math.sin(a+Math.PI/2)*off,type:Math.floor(Math.random()*POWERUP_TYPES.length),timer:0,active:true})}}
function updateOrbs(dt){for(var i=0;i<orbs.length;i++){var o=orbs[i];if(!o.active){o.timer-=dt;if(o.timer<=0){o.active=true;o.type=Math.floor(Math.random()*POWERUP_TYPES.length)}}else{for(var j=0;j<cars.length;j++){var c=cars[j];if(c.ghostActive)continue;var dx=c.x-o.x,dy=c.y-o.y;if(Math.hypot(dx,dy)<45&&c.powerup===null){c.powerup=o.type;o.active=false;o.timer=5+Math.random()*5;for(var s=0;s<8;s++){var sp=createParticle(o.x,o.y,'spark');sp.vx=(Math.random()-0.5)*200;sp.vy=(Math.random()-0.5)*200;sp.life=0.3+Math.random()*0.3;sp.maxLife=sp.life;particles.push(sp)}break}}}}if(orbs.filter(function(o){return o.active}).length<MAX_ORBS/3){var pts=track.points,n=pts.length,si=Math.floor(Math.random()*n),p=pts[si],np=pts[(si+1)%n],t=Math.random();var a=Math.atan2(np.y-p.y,np.x-p.x),off=(Math.random()-0.5)*track.roadWidth*0.4;orbs.push({x:p.x+(np.x-p.x)*t+Math.cos(a+Math.PI/2)*off,y:p.y+(np.y-p.y)*t+Math.sin(a+Math.PI/2)*off,type:Math.floor(Math.random()*POWERUP_TYPES.length),timer:0,active:true})}}
function usePowerup(car){var type=POWERUP_TYPES[car.powerup].name;if(type==='Boost'){car.speed=Math.min(car.speed+150,600);for(var i=0;i<5;i++){var p=createParticle(car.x,car.y,'nitro');p.vx=(Math.random()-0.5)*150;p.vy=(Math.random()-0.5)*150;particles.push(p)}}else if(type==='Shield'){car.shieldActive=true;car.shieldTimer=5}else if(type==='Banana'){var bx=car.x-Math.cos(car.angle-Math.PI/2)*50,by=car.y-Math.sin(car.angle-Math.PI/2)*50;hazards.push({type:'banana',x:bx,y:by,life:15})}else if(type==='Lightning'){for(var i=0;i<cars.length;i++){var c=cars[i];if(c!==car&&!c.shieldActive&&!c.ghostActive){c.slowTimer=3;c.speed*=0.3;for(var s=0;s<5;s++){var p=createParticle(c.x,c.y,'spark');p.vx=(Math.random()-0.5)*200;p.vy=(Math.random()-0.5)*200;particles.push(p)}}}}else if(type==='Missile'){var mx=Math.cos(car.angle-Math.PI/2),my=Math.sin(car.angle-Math.PI/2);missiles.push({x:car.x+mx*30,y:car.y+my*30,vx:mx*800,vy:my*800,owner:car,life:3})}else if(type==='Star'){car.starActive=true;car.starTimer=5}else if(type==='Oil'){var ox=car.x-Math.cos(car.angle-Math.PI/2)*50,oy=car.y-Math.sin(car.angle-Math.PI/2)*50;hazards.push({type:'oil',x:ox,y:oy,life:12})}else if(type==='Mega Boost'){car.speed=Math.min(car.speed+300,800);car.nitroActive=true;car.nitroDuration=2;for(var i=0;i<10;i++){var p=createParticle(car.x,car.y,'nitro');p.vx=(Math.random()-0.5)*250;p.vy=(Math.random()-0.5)*250;p.size=5+Math.random()*5;particles.push(p)}}else if(type==='Ghost'){car.ghostActive=true;car.ghostTimer=4}else if(type==='Bomb'){for(var i=0;i<cars.length;i++){var c=cars[i];if(c===car||c.shieldActive||c.ghostActive)continue;var dx=c.x-car.x,dy=c.y-car.y;if(Math.hypot(dx,dy)<400){c.spinTimer=1.5;c.spinAngle=c.angle;c.speed*=0.2;for(var s=0;s<8;s++){var p=createParticle(c.x,c.y,'spark');p.vx=(Math.random()-0.5)*300;p.vy=(Math.random()-0.5)*300;p.size=3+Math.random()*4;particles.push(p)}}}}}
function updateHazards(dt){for(var i=hazards.length-1;i>=0;i--){hazards[i].life-=dt;if(hazards[i].life<=0){hazards.splice(i,1);continue}var h=hazards[i];for(var j=0;j<cars.length;j++){var c=cars[j];if(c.shieldActive||c.ghostActive)continue;var dx=c.x-h.x,dy=c.y-h.y;if(Math.hypot(dx,dy)<25){if(h.type==='banana'){c.spinTimer=1;c.spinAngle=c.angle;c.speed*=0.3}else if(h.type==='oil'){c.speed*=0.4;c.slowTimer=2}hazards.splice(i,1);for(var s=0;s<5;s++){var p=createParticle(h.x,h.y,'spark');p.vx=(Math.random()-0.5)*150;p.vy=(Math.random()-0.5)*150;particles.push(p)}break}}}for(var i=missiles.length-1;i>=0;i--){var m=missiles[i];m.life-=dt;if(m.life<=0){missiles.splice(i,1);continue}m.x+=m.vx*dt;m.y+=m.vy*dt;for(var j=0;j<cars.length;j++){var c=cars[j];if(c===m.owner||c.shieldActive||c.ghostActive)continue;if(Math.hypot(c.x-m.x,c.y-m.y)<30){c.spinTimer=1.2;c.spinAngle=c.angle;c.speed*=0.2;for(var s=0;s<8;s++){var p=createParticle(m.x,m.y,'spark');p.vx=(Math.random()-0.5)*250;p.vy=(Math.random()-0.5)*250;p.size=2+Math.random()*3;particles.push(p)}missiles.splice(i,1);break}}}}
function updatePowerupEffects(allCars,dt){for(var i=0;i<allCars.length;i++){var c=allCars[i];if(c.shieldActive){c.shieldTimer-=dt;if(c.shieldTimer<=0)c.shieldActive=false}if(c.starActive){c.starTimer-=dt;if(c.starTimer<=0)c.starActive=false;c.speed=Math.min(c.speed+200*dt,600);for(var j=0;j<allCars.length;j++){var oc=allCars[j];if(oc===c||oc.shieldActive)continue;if(Math.hypot(oc.x-c.x,oc.y-c.y)<35){oc.spinTimer=0.8;oc.spinAngle=oc.angle;oc.speed*=0.3}}}if(c.ghostActive){c.ghostTimer-=dt;if(c.ghostTimer<=0)c.ghostActive=false}if(c.slowTimer>0){c.slowTimer-=dt;c.speed=Math.min(c.speed,200)}if(c.spinTimer>0){c.spinTimer-=dt;c.angle=c.spinAngle+((1-c.spinTimer)*Math.PI*4);c.speed*=0.95}}}
function aiUsePowerups(){for(var i=0;i<cars.length;i++){var c=cars[i];if(c.isPlayer||c.powerup===null)continue;if(Math.random()<0.008){usePowerup(c);c.powerup=null}}}
function drawOrbs(){var t=performance.now()*0.001;for(var i=0;i<orbs.length;i++){var o=orbs[i];if(!o.active)continue;var pt=POWERUP_TYPES[o.type],bob=Math.sin(t*3+i*1.7)*6,pulse=1+Math.sin(t*4+i*2.3)*0.08,spin=t*2+i*0.8,cx=o.x,cy=o.y+bob;ctx.save();ctx.shadowColor=pt.color;ctx.shadowBlur=45;ctx.fillStyle='rgba(255,255,255,0.04)';ctx.beginPath();ctx.arc(cx,cy,50*pulse,0,Math.PI*2);ctx.fill();for(var s=0;s<6;s++){var sa=spin+s*Math.PI/3,sr=34*pulse,sx=cx+Math.cos(sa)*sr,sy=cy+Math.sin(sa)*sr,sparkSize=2+Math.sin(t*6+s*1.1)*1.5;ctx.fillStyle=pt.color;ctx.globalAlpha=0.5+Math.sin(t*5+s*0.9)*0.3;ctx.beginPath();ctx.arc(sx,sy,sparkSize,0,Math.PI*2);ctx.fill()}ctx.globalAlpha=1;ctx.strokeStyle=pt.color;ctx.lineWidth=2;ctx.setLineDash([4,6]);ctx.lineDashOffset=-t*80;ctx.beginPath();ctx.arc(cx,cy,32*pulse,0,Math.PI*2);ctx.stroke();ctx.setLineDash([]);ctx.shadowBlur=30;var g=ctx.createRadialGradient(cx-4,cy-4,0,cx,cy,28*pulse);g.addColorStop(0,'rgba(255,255,255,0.98)');g.addColorStop(0.25,'rgba(255,255,255,0.7)');g.addColorStop(0.5,pt.color);g.addColorStop(0.85,pt.color);g.addColorStop(1,'rgba(0,0,0,0.3)');ctx.fillStyle=g;ctx.beginPath();ctx.arc(cx,cy,26*pulse,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;ctx.fillStyle='rgba(255,255,255,0.35)';ctx.beginPath();ctx.ellipse(cx-5,cy-8*pulse,10*pulse,6*pulse,-0.3,0,Math.PI*2);ctx.fill();ctx.font='22px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(pt.icon,cx,cy+1);ctx.restore()}}
function drawHazards(){var t=performance.now()*0.001;for(var i=0;i<hazards.length;i++){var h=hazards[i];ctx.save();if(h.type==='banana'){ctx.shadowColor='#ffcc00';ctx.shadowBlur=12;ctx.font='24px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.save();ctx.translate(h.x,h.y);ctx.rotate(Math.sin(t*2+i)*0.3);ctx.fillText('\u{1F34C}',0,0);ctx.restore();ctx.shadowBlur=0;ctx.fillStyle='rgba(255,204,0,0.15)';ctx.beginPath();ctx.arc(h.x,h.y,18,0,Math.PI*2);ctx.fill()}else if(h.type==='oil'){var og=ctx.createRadialGradient(h.x,h.y,0,h.x,h.y,20);og.addColorStop(0,'rgba(80,0,160,0.7)');og.addColorStop(0.5,'rgba(40,0,80,0.5)');og.addColorStop(1,'rgba(20,0,40,0.1)');ctx.fillStyle=og;ctx.beginPath();ctx.ellipse(h.x,h.y,22,14,Math.sin(t+i)*0.2,0,Math.PI*2);ctx.fill();var rg=ctx.createRadialGradient(h.x-3,h.y-2,0,h.x,h.y,14);rg.addColorStop(0,'rgba(255,100,200,0.25)');rg.addColorStop(0.5,'rgba(100,200,255,0.2)');rg.addColorStop(1,'rgba(100,0,200,0.1)');ctx.fillStyle=rg;ctx.beginPath();ctx.ellipse(h.x-2,h.y-1,14,8,0.3+Math.sin(t*1.5)*0.2,0,Math.PI*2);ctx.fill()}ctx.restore()}for(var i=0;i<missiles.length;i++){var m=missiles[i];ctx.save();ctx.translate(m.x,m.y);var ma=Math.atan2(m.vy,m.vx)-Math.PI/2;ctx.rotate(ma);ctx.shadowColor='#33cc33';ctx.shadowBlur=15;var mg=ctx.createLinearGradient(0,-10,0,10);mg.addColorStop(0,'#66ff66');mg.addColorStop(0.5,'#33cc33');mg.addColorStop(1,'#116611');ctx.fillStyle=mg;ctx.beginPath();ctx.moveTo(0,-10);ctx.lineTo(-5,6);ctx.lineTo(-2,4);ctx.lineTo(0,10);ctx.lineTo(2,4);ctx.lineTo(5,6);ctx.closePath();ctx.fill();ctx.shadowBlur=0;ctx.fillStyle='#ff6644';ctx.beginPath();ctx.arc(0,8,4,0,Math.PI*2);ctx.fill();ctx.fillStyle='#ffaa44';ctx.beginPath();ctx.arc(0,12,2+Math.random()*2,0,Math.PI*2);ctx.fill();ctx.restore()}}
function drawCarEffects(car){var t=performance.now()*0.001;if(car.shieldActive){ctx.save();var shieldPulse=0.5+Math.sin(t*6)*0.2;ctx.shadowColor='#4488ff';ctx.shadowBlur=25;var sg=ctx.createRadialGradient(car.x,car.y,14,car.x,car.y,26);sg.addColorStop(0,'rgba(68,136,255,0)');sg.addColorStop(0.6,'rgba(68,136,255,'+shieldPulse*0.15+')');sg.addColorStop(0.85,'rgba(100,180,255,'+shieldPulse*0.4+')');sg.addColorStop(1,'rgba(68,136,255,0)');ctx.fillStyle=sg;ctx.beginPath();ctx.arc(car.x,car.y,26,0,Math.PI*2);ctx.fill();for(var r=0;r<3;r++){var ra=t*3+r*Math.PI*2/3,rr=22+r*2;ctx.strokeStyle='rgba(100,180,255,'+(0.3+Math.sin(t*5+r)*0.2)+')';ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(car.x,car.y,rr,ra,ra+Math.PI*0.8);ctx.stroke()}ctx.strokeStyle='rgba(68,136,255,'+shieldPulse+')';ctx.lineWidth=2.5;ctx.beginPath();ctx.arc(car.x,car.y,22,0,Math.PI*2);ctx.stroke();for(var h=0;h<6;h++){var ha=t*4+h*Math.PI/3,hx=car.x+Math.cos(ha)*22,hy=car.y+Math.sin(ha)*22;ctx.fillStyle='rgba(150,200,255,'+(0.6+Math.sin(t*8+h)*0.4)+')';ctx.beginPath();ctx.arc(hx,hy,1.5,0,Math.PI*2);ctx.fill()}ctx.restore()}if(car.starActive){ctx.save();ctx.shadowColor='#ff88ff';ctx.shadowBlur=30;var starGlow=ctx.createRadialGradient(car.x,car.y,10,car.x,car.y,30);starGlow.addColorStop(0,'rgba(255,136,255,0.1)');starGlow.addColorStop(0.5,'rgba(255,200,100,0.08)');starGlow.addColorStop(1,'rgba(255,136,255,0)');ctx.fillStyle=starGlow;ctx.beginPath();ctx.arc(car.x,car.y,30,0,Math.PI*2);ctx.fill();ctx.strokeStyle='rgba(255,136,255,'+(0.4+Math.sin(t*8)*0.3)+')';ctx.lineWidth=2;ctx.beginPath();ctx.arc(car.x,car.y,25,0,Math.PI*2);ctx.stroke();for(var s=0;s<8;s++){var sa=t*4+s*Math.PI/4,sr=20+Math.sin(t*6+s*1.3)*6,sparkA=0.5+Math.sin(t*7+s*0.8)*0.4;var sx=car.x+Math.cos(sa)*sr,sy=car.y+Math.sin(sa)*sr;ctx.fillStyle='rgba(255,255,100,'+sparkA+')';ctx.beginPath();ctx.arc(sx,sy,2.5-Math.sin(t*5+s)*1,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(255,200,255,'+sparkA*0.5+')';ctx.beginPath();ctx.arc(sx,sy,4,0,Math.PI*2);ctx.fill()}var trail=5;for(var tt=0;tt<trail;tt++){var td=tt*0.06,tx=car.x-Math.cos(car.angle-Math.PI/2)*tt*8,ty=car.y-Math.sin(car.angle-Math.PI/2)*tt*8,ta=0.3*(1-tt/trail);ctx.fillStyle='rgba(255,200,100,'+ta+')';ctx.beginPath();ctx.arc(tx,ty,3-tt*0.4,0,Math.PI*2);ctx.fill()}ctx.restore()}}
function drawPowerupHUD(){if(!player)return;ctx.save();ctx.setTransform(1,0,0,1,0,0);if(player.powerup!==null){var pt=POWERUP_TYPES[player.powerup],t=performance.now()*0.001,pulse=1+Math.sin(t*5)*0.03;ctx.shadowColor=pt.color;ctx.shadowBlur=20;ctx.fillStyle='rgba(0,0,0,0.8)';drawPanel(W/2-55,H-60,110,50,10);ctx.fill();ctx.strokeStyle=pt.color;ctx.lineWidth=2.5;ctx.globalAlpha=0.6+Math.sin(t*4)*0.2;ctx.stroke();ctx.globalAlpha=1;var ig=ctx.createRadialGradient(W/2-20,H-34,0,W/2-20,H-34,18);ig.addColorStop(0,'rgba(255,255,255,0.12)');ig.addColorStop(1,'rgba(255,255,255,0)');ctx.fillStyle=ig;ctx.beginPath();ctx.arc(W/2-20,H-34,18,0,Math.PI*2);ctx.fill();ctx.shadowBlur=10;ctx.font='24px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(pt.icon,W/2-20,H-34);ctx.shadowBlur=0;ctx.fillStyle=pt.color;ctx.font='bold 14px Courier New';ctx.fillText(pt.name,W/2+18,H-34);ctx.fillStyle='rgba(255,255,255,0.4)';ctx.font='bold 10px Courier New';ctx.fillText('[E]',W/2,H-14)}ctx.restore()}
function drawHUDHalf(p,ox,hw,label){ctx.save();ctx.setTransform(1,0,0,1,0,0);ctx.beginPath();ctx.rect(ox,0,hw,H);ctx.clip();ctx.fillStyle='rgba(0,0,0,0.65)';drawPanel(ox+5,5,55,36,5);ctx.fill();ctx.strokeStyle='rgba(255,215,0,0.3)';ctx.lineWidth=1;ctx.stroke();ctx.fillStyle='#ffd700';ctx.font='bold 22px Courier New';ctx.fillText(p.position+'',ox+12,32);ctx.fillStyle='#cca800';ctx.font='11px Courier New';ctx.fillText(getOrdinal(p.position),ox+38,32);ctx.fillStyle='rgba(0,0,0,0.65)';drawPanel(ox+65,5,75,36,5);ctx.fill();ctx.strokeStyle='rgba(255,255,255,0.1)';ctx.lineWidth=1;ctx.stroke();ctx.fillStyle='#888';ctx.font='9px Courier New';ctx.fillText('LAP',ox+72,18);ctx.fillStyle='#fff';ctx.font='bold 16px Courier New';ctx.fillText(Math.min(p.lap+1,TOTAL_LAPS)+'/'+TOTAL_LAPS,ox+72,34);ctx.fillStyle='rgba(0,0,0,0.65)';drawPanel(ox+145,5,80,36,5);ctx.fill();ctx.strokeStyle='rgba(0,255,0,0.15)';ctx.lineWidth=1;ctx.stroke();ctx.fillStyle='#666';ctx.font='9px Courier New';ctx.fillText('SPEED',ox+152,18);var ds=Math.abs(Math.round(p.speed*0.6));ctx.fillStyle=ds>180?'#ff4444':ds>120?'#ffaa00':'#00dd00';ctx.font='bold 15px Courier New';ctx.fillText(ds+'',ox+152,34);ctx.fillStyle='rgba(0,0,0,0.65)';drawPanel(ox+5,46,80,22,4);ctx.fill();ctx.strokeStyle='rgba(255,136,0,0.2)';ctx.lineWidth=1;ctx.stroke();ctx.fillStyle='#888';ctx.font='9px Courier New';ctx.fillText('NITRO',ox+10,58);for(let i=0;i<NITRO_MAX;i++){var nx=ox+50+i*18,ny=48;if(i<p.nitro){ctx.save();ctx.shadowColor='rgba(255,136,0,0.5)';ctx.shadowBlur=4;var ng2=ctx.createLinearGradient(nx,ny,nx,ny+13);ng2.addColorStop(0,'#ffaa00');ng2.addColorStop(1,'#ff6600');ctx.fillStyle=ng2;ctx.fillRect(nx,ny,14,13);ctx.restore()}else{ctx.fillStyle='#222';ctx.fillRect(nx,ny,14,13);ctx.strokeStyle='#333';ctx.lineWidth=1;ctx.strokeRect(nx,ny,14,13)}}ctx.fillStyle='rgba(0,0,0,0.55)';drawPanel(ox+5,72,30,16,3);ctx.fill();ctx.fillStyle='#aaa';ctx.font='bold 10px Courier New';ctx.fillText(label,ox+10,84);drawMinimapHalf(ox,hw);ctx.restore()}
function drawMinimapHalf(ox,hw){var mW=100,mH=75,mX=ox+hw-mW-5,mY=5;ctx.fillStyle='rgba(0,0,0,0.7)';drawPanel(mX,mY,mW,mH,5);ctx.fill();ctx.strokeStyle='rgba(255,255,255,0.1)';ctx.lineWidth=1;ctx.stroke();var pts=track.points,mnX=Infinity,mxX=-Infinity,mnY=Infinity,mxY=-Infinity;for(var p of pts){mnX=Math.min(mnX,p.x);mxX=Math.max(mxX,p.x);mnY=Math.min(mnY,p.y);mxY=Math.max(mxY,p.y)}var pd=40,sc=Math.min((mW-14)/(mxX-mnX+pd*2),(mH-14)/(mxY-mnY+pd*2)),oX=mX+mW/2-((mxX+mnX)/2)*sc,oY=mY+mH/2-((mxY+mnY)/2)*sc;ctx.strokeStyle='#555';ctx.lineWidth=3;ctx.lineCap='round';ctx.lineJoin='round';ctx.beginPath();ctx.moveTo(pts[0].x*sc+oX,pts[0].y*sc+oY);for(let i=1;i<=pts.length;i++)ctx.lineTo(pts[i%pts.length].x*sc+oX,pts[i%pts.length].y*sc+oY);ctx.closePath();ctx.stroke();ctx.strokeStyle='#777';ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(pts[0].x*sc+oX,pts[0].y*sc+oY);for(let i=1;i<=pts.length;i++)ctx.lineTo(pts[i%pts.length].x*sc+oX,pts[i%pts.length].y*sc+oY);ctx.closePath();ctx.stroke();for(var car of cars){var cx=car.x*sc+oX,cy=car.y*sc+oY;if(car.isPlayer&&!car.isPlayer2){ctx.fillStyle='rgba(255,255,255,0.2)';ctx.beginPath();ctx.arc(cx,cy,4,0,Math.PI*2);ctx.fill()}if(car.isPlayer2){ctx.fillStyle='rgba(255,255,255,0.2)';ctx.beginPath();ctx.arc(cx,cy,4,0,Math.PI*2);ctx.fill()}ctx.fillStyle=car.color;ctx.beginPath();ctx.arc(cx,cy,(car.isPlayer||car.isPlayer2)?3:2,0,Math.PI*2);ctx.fill();if(car.isPlayer||car.isPlayer2){ctx.strokeStyle='#fff';ctx.lineWidth=1;ctx.stroke()}}}
function drawHUDSplit(){if(!player)return;drawHUDHalf(player,0,W/2,'P1');if(player2)drawHUDHalf(player2,W/2,W/2,'P2');ctx.save();ctx.setTransform(1,0,0,1,0,0);ctx.fillStyle='rgba(0,0,0,0.65)';drawPanel(W/2-55,5,110,36,5);ctx.fill();ctx.strokeStyle='rgba(255,255,255,0.1)';ctx.lineWidth=1;ctx.stroke();ctx.fillStyle='#666';ctx.font='9px Courier New';ctx.fillText('TIME',W/2-45,18);ctx.fillStyle='#fff';ctx.font='bold 15px Courier New';ctx.fillText(formatTime(performance.now()-raceTimer),W/2-45,34);ctx.restore()}
function drawPowerupHUDSplit(){var t=performance.now()*0.001;ctx.save();ctx.setTransform(1,0,0,1,0,0);if(player&&player.powerup!==null){var pt=POWERUP_TYPES[player.powerup];ctx.shadowColor=pt.color;ctx.shadowBlur=15;ctx.fillStyle='rgba(0,0,0,0.8)';drawPanel(W/4-42,H-48,84,40,7);ctx.fill();ctx.strokeStyle=pt.color;ctx.lineWidth=2;ctx.globalAlpha=0.6+Math.sin(t*4)*0.2;ctx.stroke();ctx.globalAlpha=1;ctx.shadowBlur=8;ctx.font='20px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(pt.icon,W/4-16,H-28);ctx.shadowBlur=0;ctx.fillStyle=pt.color;ctx.font='bold 11px Courier New';ctx.fillText(pt.name,W/4+14,H-28);ctx.textAlign='start';ctx.textBaseline='alphabetic'}if(player2&&player2.powerup!==null){var pt2=POWERUP_TYPES[player2.powerup];ctx.shadowColor=pt2.color;ctx.shadowBlur=15;ctx.fillStyle='rgba(0,0,0,0.8)';drawPanel(W/2+W/4-42,H-48,84,40,7);ctx.fill();ctx.strokeStyle=pt2.color;ctx.lineWidth=2;ctx.globalAlpha=0.6+Math.sin(t*4)*0.2;ctx.stroke();ctx.globalAlpha=1;ctx.shadowBlur=8;ctx.font='20px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(pt2.icon,W/2+W/4-16,H-28);ctx.shadowBlur=0;ctx.fillStyle=pt2.color;ctx.font='bold 11px Courier New';ctx.fillText(pt2.name,W/2+W/4+14,H-28);ctx.textAlign='start';ctx.textBaseline='alphabetic'}ctx.restore()}
function drawDirectionArrowSplit(){if(!player||player.finished){}else{ctx.save();ctx.setTransform(1,0,0,1,0,0);ctx.beginPath();ctx.rect(0,0,W/2,H);ctx.clip();var cps=track.checkpoints,cp=cps[player.checkpoint%cps.length];var dx=cp.x-player.x,dy=cp.y-player.y,a=Math.atan2(dy,dx)+cameraAngle;var ax=W/4+Math.cos(a)*60,ay=H/2+Math.sin(a)*60,sz=20;ctx.save();ctx.translate(ax,ay);ctx.rotate(a);ctx.shadowColor='rgba(255,136,0,0.8)';ctx.shadowBlur=10;ctx.fillStyle='#ff8800';ctx.beginPath();ctx.moveTo(sz,0);ctx.lineTo(-sz*0.7,-sz*0.65);ctx.lineTo(-sz*0.25,0);ctx.lineTo(-sz*0.7,sz*0.65);ctx.closePath();ctx.fill();ctx.shadowBlur=0;ctx.restore();ctx.restore()}if(!player2||player2.finished){}else{ctx.save();ctx.setTransform(1,0,0,1,0,0);ctx.beginPath();ctx.rect(W/2,0,W/2,H);ctx.clip();var cps2=track.checkpoints,cp2=cps2[player2.checkpoint%cps2.length];var dx2=cp2.x-player2.x,dy2=cp2.y-player2.y,a2=Math.atan2(dy2,dx2)+cam2Angle;var ax2=W/2+W/4+Math.cos(a2)*60,ay2=H/2+Math.sin(a2)*60,sz2=20;ctx.save();ctx.translate(ax2,ay2);ctx.rotate(a2);ctx.shadowColor='rgba(255,136,0,0.8)';ctx.shadowBlur=10;ctx.fillStyle='#ff8800';ctx.beginPath();ctx.moveTo(sz2,0);ctx.lineTo(-sz2*0.7,-sz2*0.65);ctx.lineTo(-sz2*0.25,0);ctx.lineTo(-sz2*0.7,sz2*0.65);ctx.closePath();ctx.fill();ctx.shadowBlur=0;ctx.restore();ctx.restore()}}
function drawTrackPreview(id,ti){var c=document.getElementById(id);if(!c)return;var px=c.getContext('2d'),pw=c.width,ph=c.height;px.fillStyle='#1a3a0e';px.fillRect(0,0,pw,ph);var td=TRACKS[ti],pts=td.points,mnX=Infinity,mxX=-Infinity,mnY=Infinity,mxY=-Infinity;for(var p of pts){mnX=Math.min(mnX,p.x);mxX=Math.max(mxX,p.x);mnY=Math.min(mnY,p.y);mxY=Math.max(mxY,p.y)}var pd=60,sc=Math.min((pw-20)/(mxX-mnX+pd*2),(ph-20)/(mxY-mnY+pd*2)),oX=pw/2-((mxX+mnX)/2)*sc,oY=ph/2-((mxY+mnY)/2)*sc;px.strokeStyle='#6a5a2a';px.lineWidth=Math.max(3,td.roadWidth*sc*0.7);px.lineCap='round';px.lineJoin='round';px.beginPath();px.moveTo(pts[0].x*sc+oX,pts[0].y*sc+oY);for(let i=1;i<=pts.length;i++)px.lineTo(pts[i%pts.length].x*sc+oX,pts[i%pts.length].y*sc+oY);px.closePath();px.stroke();px.strokeStyle='#555';px.lineWidth=Math.max(2,td.roadWidth*sc*0.5);px.beginPath();px.moveTo(pts[0].x*sc+oX,pts[0].y*sc+oY);for(let i=1;i<=pts.length;i++)px.lineTo(pts[i%pts.length].x*sc+oX,pts[i%pts.length].y*sc+oY);px.closePath();px.stroke();px.strokeStyle='#888';px.lineWidth=1;px.setLineDash([4,4]);px.beginPath();px.moveTo(pts[0].x*sc+oX,pts[0].y*sc+oY);for(let i=1;i<=pts.length;i++)px.lineTo(pts[i%pts.length].x*sc+oX,pts[i%pts.length].y*sc+oY);px.closePath();px.stroke();px.setLineDash([])}
function initRace(ti){var td=TRACKS[ti],pts=td.points;pts=smoothTrackPoints(pts);pts=smoothTrackPoints(pts);generateElevation(pts,2+Math.floor(Math.random()*3));track={points:pts,roadWidth:td.roadWidth,checkpoints:null};track.checkpoints=buildCheckpoints(track);generateDecorations(track);skidMarks=[];var sp=pts[0],np=pts[Math.min(3,pts.length-1)],sa=Math.atan2(np.y-sp.y,np.x-sp.x)+Math.PI/2,px=Math.cos(sa+Math.PI/2),py=Math.sin(sa+Math.PI/2),fx=Math.cos(sa),fy=Math.sin(sa);cars=[];particles=[];finishOrder=[];raceFinished=false;player2=null;var numAI=multiplayer?4:5;var colorOffset=multiplayer?2:1;for(let i=0;i<numAI;i++){var r=Math.floor(i/2),si=(i%2===0)?-1:1,ox=si*25,oy=(r+1)*50;var ai=createCar(sp.x+px*ox+fx*oy,sp.y+py*ox+fy*oy,sa,CAR_COLORS[(i+colorOffset)%CAR_COLORS.length],false);ai.targetWaypoint=1;cars.push(ai)}var backRow=Math.ceil(numAI/2)+1;player=createCar(sp.x+px*(-20)-fx*backRow*50,sp.y+py*(-20)-fy*backRow*50,sa,CAR_COLORS[0],true);cars.push(player);if(multiplayer){player2=createCar(sp.x+px*20-fx*backRow*50,sp.y+py*20-fy*backRow*50,sa,CAR_COLORS[1],true);player2.isPlayer2=true;cars.push(player2);cam2X=player2.x;cam2Y=player2.y;cam2Angle=-player2.angle;cam2Zoom=0.7}cameraX=player.x;cameraY=player.y;cameraAngle=-player.angle;cameraZoom=1;raceTimer=0;spawnOrbs();state='countdown';countdownNum=3;countdownTimer=performance.now()}
document.addEventListener('keydown',function(e){keys[e.key.toLowerCase()]=true;keys[e.code]=true;keys[e.key]=true;if(e.key===' '||e.key.startsWith('Arrow')||e.key==='/'||e.key==='Enter')e.preventDefault()});
document.addEventListener('keyup',function(e){keys[e.key.toLowerCase()]=false;keys[e.code]=false;keys[e.key]=false});
if('ontouchstart'in window||navigator.maxTouchPoints>0){document.getElementById('touchLeft').style.display='block';document.getElementById('touchRight').style.display='block'}
canvas.addEventListener('touchstart',handleTouch,{passive:false});canvas.addEventListener('touchmove',handleTouch,{passive:false});canvas.addEventListener('touchend',handleTouchEnd,{passive:false});
function handleTouch(e){e.preventDefault();touchSteerDir=0;touchGas=false;touchBrake=false;for(var i=0;i<e.touches.length;i++){var t=e.touches[i],r=canvas.getBoundingClientRect(),rx=(t.clientX-r.left)/r.width,ry=(t.clientY-r.top)/r.height;if(rx<0.5)touchSteerDir=rx<0.25?-1:1;else{if(ry<0.5)touchGas=true;else touchBrake=true}}}
function handleTouchEnd(e){e.preventDefault();if(!e.touches.length){touchSteerDir=0;touchGas=false;touchBrake=false}else handleTouch(e)}
function processInput(){if(!player||player.finished||player.spinTimer>0)return;player.acceleration=0;if(multiplayer){if(keys['w']||touchGas)player.acceleration=1;if(keys['s']||touchBrake)player.acceleration=-1;var steerInput=0;if(keys['a']||touchSteerDir===-1)steerInput=-1;if(keys['d']||touchSteerDir===1)steerInput=1}else{if(keys['arrowup']||keys['w']||touchGas)player.acceleration=1;if(keys['arrowdown']||keys['s']||touchBrake)player.acceleration=-1;var steerInput=0;if(keys['arrowleft']||keys['a']||touchSteerDir===-1)steerInput=-1;if(keys['arrowright']||keys['d']||touchSteerDir===1)steerInput=1}if(steerInput!==0){player.steering+=(steerInput-player.steering)*0.12}else{player.steering*=0.8;if(Math.abs(player.steering)<0.01)player.steering=0}if(keys['Space']||keys[' ']){activateNitro(player);keys['Space']=false;keys[' ']=false}if(keys['e']){if(player.powerup!==null){usePowerup(player);player.powerup=null}keys['e']=false}if(!multiplayer&&keys['Shift']){if(player.powerup!==null){usePowerup(player);player.powerup=null}keys['Shift']=false}}
function processInput2(){if(!player2||player2.finished||player2.spinTimer>0)return;player2.acceleration=0;if(keys['arrowup'])player2.acceleration=1;if(keys['arrowdown'])player2.acceleration=-1;var steerInput=0;if(keys['arrowleft'])steerInput=-1;if(keys['arrowright'])steerInput=1;if(steerInput!==0){player2.steering+=(steerInput-player2.steering)*0.12}else{player2.steering*=0.8;if(Math.abs(player2.steering)<0.01)player2.steering=0}if(keys['Enter']){activateNitro(player2);keys['Enter']=false}if(keys['/']){if(player2.powerup!==null){usePowerup(player2);player2.powerup=null}keys['/']=false}}
var menuScreen=document.getElementById('menuScreen'),resultsScreen=document.getElementById('resultsScreen');
document.getElementById('mode1P').addEventListener('click',function(){multiplayer=false;this.classList.add('active');document.getElementById('mode2P').classList.remove('active');document.getElementById('controlsHint').textContent='WASD / Arrows to drive \u2022 Space = Nitro \u2022 E = Power-up'});
document.getElementById('mode2P').addEventListener('click',function(){multiplayer=true;this.classList.add('active');document.getElementById('mode1P').classList.remove('active');document.getElementById('controlsHint').innerHTML='P1: WASD + Space + E &nbsp;\u2022&nbsp; P2: Arrows + Enter + /'});
document.getElementById('startBtn').addEventListener('click',function(){menuScreen.style.display='none';resultsScreen.style.display='none';initRace(selectedTrack)});
document.getElementById('replayBtn').addEventListener('click',function(){resultsScreen.style.display='none';initRace(selectedTrack)});
document.getElementById('menuBtn').addEventListener('click',function(){resultsScreen.style.display='none';menuScreen.style.display='flex';state='menu'});
function showResults(){var table=document.getElementById('resultsTable');table.innerHTML='';var sorted=[].concat(cars).sort(function(a,b){return a.finishPos-b.finishPos});sorted.forEach(function(car,i){var row=document.createElement('div'),pos=i+1,name=car.isPlayer2?'P2':car.isPlayer?'P1'+(multiplayer?'':''):'CAR '+cars.indexOf(car);if(!multiplayer&&car.isPlayer)name='YOU';var time=car.didNotFinish?'DNF':formatTime(car.totalTime);row.innerHTML='<span>'+pos+getOrdinal(pos)+' <span style="display:inline-block;width:12px;height:12px;background:'+car.color+';border-radius:2px;margin-right:8px;vertical-align:middle;"></span>'+name+'</span><span>'+time+'</span>';if(car.isPlayer&&!car.isPlayer2)row.style.color='#ff4444';if(car.isPlayer2)row.style.color='#3399ff';table.appendChild(row)});resultsScreen.style.display='flex'}
function drawWorld(camX,camY,camAng,camZm,vpX,vpY,vpW,vpH){ctx.save();ctx.beginPath();ctx.rect(vpX,vpY,vpW,vpH);ctx.clip();ctx.save();ctx.translate(vpX+vpW/2,vpY+vpH/2);ctx.scale(camZm,camZm);ctx.rotate(camAng);ctx.translate(-camX,-camY);var zr=1/Math.max(0.5,camZm);ctx.fillStyle='#2a5518';ctx.fillRect(camX-vpW*2*zr,camY-vpH*2*zr,vpW*4*zr,vpH*4*zr);var ts=40,sgx=Math.floor((camX-vpW*2*zr)/ts)*ts,sgy=Math.floor((camY-vpH*2*zr)/ts)*ts;for(var gx=sgx;gx<camX+vpW*2*zr;gx+=ts)for(var gy=sgy;gy<camY+vpH*2*zr;gy+=ts){var tx=Math.floor(gx/ts),ty=Math.floor(gy/ts),h=((tx*73856093)^(ty*19349663))&0xFF;if(h<80){ctx.fillStyle='#2e5e1c';ctx.fillRect(gx,gy,ts,ts)}else if(h<160){ctx.fillStyle='#275216';ctx.fillRect(gx,gy,ts,ts)}else if(h<200){ctx.fillStyle='#306820';ctx.fillRect(gx,gy,ts,ts)}if(h>240){ctx.fillStyle=h>250?'rgba(255,255,100,0.15)':'rgba(255,200,200,0.1)';ctx.beginPath();ctx.arc(gx+(h%30)+5,gy+((h*3)%30)+5,2,0,Math.PI*2);ctx.fill()}}drawDecorations();drawTrack();drawParticles();var sc2=[].concat(cars).sort(function(a,b){return a.y-b.y});drawOrbs();drawHazards();for(var j=0;j<sc2.length;j++){if(sc2[j].ghostActive){ctx.save();ctx.globalAlpha=0.35}drawCar(sc2[j]);drawCarEffects(sc2[j]);if(sc2[j].ghostActive)ctx.restore()}ctx.restore();ctx.restore()}
var lastTime=performance.now();
function gameLoop(time){var dt=Math.min((time-lastTime)/1000,0.05);lastTime=time;if(state==='countdown'){var el=time-countdownTimer;if(el>1000&&countdownNum===3)countdownNum=2;if(el>2000&&countdownNum===2)countdownNum=1;if(el>3000&&countdownNum===1)countdownNum=0;if(el>3800){state='racing';raceTimer=performance.now();cars.forEach(function(c){c.lapStart=performance.now()})}}if(state==='racing'){processInput();if(multiplayer)processInput2();for(var i2=0;i2<cars.length;i2++){var car=cars[i2];if(!car.isPlayer)updateAI(car,dt);updateCar(car,dt);updateCheckpoints(car);spawnCarParticles(car)}carCollisions();calcPositions();updateParticles(dt);updateOrbs(dt);updateHazards(dt);updatePowerupEffects(cars,dt);aiUsePowerups();var anyFinished=cars.some(function(c){return c.finished});if(anyFinished&&!raceFinished){raceFinished=true;setTimeout(function(){var nextPos=finishOrder.length+1;cars.forEach(function(c){if(!c.finished){c.finished=true;c.didNotFinish=true;c.totalTime=performance.now()-raceTimer;c.finishPos=nextPos;nextPos++}});showResults();state='results'},3000)}}if(player){cameraX+=(player.x-cameraX)*0.08;cameraY+=(player.y-cameraY)*0.08;var targetAngle=-player.angle;var ad2=targetAngle-cameraAngle;while(ad2>Math.PI)ad2-=Math.PI*2;while(ad2<-Math.PI)ad2+=Math.PI*2;cameraAngle+=ad2*0.12;var targetZoom=multiplayer?0.7:1;if(player.elev!==undefined){targetZoom+=player.elev/400}cameraZoom+=(targetZoom-cameraZoom)*0.06}if(multiplayer&&player2){cam2X+=(player2.x-cam2X)*0.08;cam2Y+=(player2.y-cam2Y)*0.08;var ta2=-player2.angle;var ad3=ta2-cam2Angle;while(ad3>Math.PI)ad3-=Math.PI*2;while(ad3<-Math.PI)ad3+=Math.PI*2;cam2Angle+=ad3*0.12;var tz2=0.7;if(player2.elev!==undefined){tz2+=player2.elev/400}cam2Zoom+=(tz2-cam2Zoom)*0.06}ctx.clearRect(0,0,W,H);if(state==='menu'){ctx.fillStyle='#0a0a1a';ctx.fillRect(0,0,W,H)}else if(multiplayer){drawWorld(cameraX,cameraY,cameraAngle,cameraZoom,0,0,W/2,H);drawWorld(cam2X,cam2Y,cam2Angle,cam2Zoom,W/2,0,W/2,H);ctx.save();ctx.setTransform(1,0,0,1,0,0);ctx.strokeStyle='#333';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(W/2,0);ctx.lineTo(W/2,H);ctx.stroke();ctx.restore();drawSpeedLines();drawVignette();if(state==='racing'||state==='countdown'){drawHUDSplit();drawPowerupHUDSplit();drawDirectionArrowSplit()}if(state==='countdown')drawCountdown()}else{drawWorld(cameraX,cameraY,cameraAngle,cameraZoom,0,0,W,H);drawSpeedLines();drawVignette();if(state==='racing'||state==='countdown'){drawHUD();drawPowerupHUD();drawDirectionArrow()}if(state==='countdown')drawCountdown()}requestAnimationFrame(gameLoop)}
const TRACK_DESCS=['Simple oval. Great for beginners.','Crossing figure-8 layout.','Three corners, long straights.','Wavy S-curves throughout.','Three-lobed clover shape.','One tight end, one sweeping.','Five bumps around a loop.','Tight inner, wide outer curve.','Rectangle with tight corners.','Long fast straights, top speed.'];
var trackSelectEl=document.getElementById('trackSelect');
for(let i=0;i<TRACKS.length;i++){var card=document.createElement('div');card.className='track-card'+(i===0?' selected':'');card.dataset.track=i;card.innerHTML='<canvas id="preview'+i+'" width="150" height="100"></canvas><h3>'+TRACKS[i].name+'</h3><p>'+(TRACK_DESCS[i]||'')+'</p>';trackSelectEl.appendChild(card);card.addEventListener('click',function(){document.querySelectorAll('.track-card').forEach(function(c){c.classList.remove('selected')});this.classList.add('selected');selectedTrack=parseInt(this.dataset.track)})}
for(let i=0;i<TRACKS.length;i++)drawTrackPreview('preview'+i,i);
requestAnimationFrame(gameLoop);
</script>
</body>
</html>
